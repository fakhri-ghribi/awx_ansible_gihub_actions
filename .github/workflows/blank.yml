name: Run AWX Playbook

on:
  schedule:
    - cron: '0 * * * *'  # This will run the workflow every hour. Adjust as needed.
  push:
    branches:
      - main  # Adjust this to your target branch

jobs:
  run-playbook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Set up environment
        env:
          AWX_HOST: ${{ secrets.AWX_HOST }}          # AWX server URL from ngrok
          AWX_USERNAME: ${{ secrets.AWX_USERNAME }}  # AWX admin username
          AWX_PASSWORD: ${{ secrets.AWX_PASSWORD }}  # AWX admin password
        run: |
          echo "Environment variables set."

      - name: Run Playbook on AWX
        env:
          AWX_HOST: ${{ secrets.AWX_HOST }}
          AWX_USERNAME: ${{ secrets.AWX_USERNAME }}
          AWX_PASSWORD: ${{ secrets.AWX_PASSWORD }}
        run: |
          # Get the project ID for the linked GitHub repo
          echo "Fetching project ID..."
          PROJECT_ID=$(curl -s -u $AWX_USERNAME:$AWX_PASSWORD \
            -X GET "$AWX_HOST/api/v2/projects/?name=First_AWX_Github" | jq -r '.results[0].id')

          if [ -z "$PROJECT_ID" ]; then
            echo "Project ID not found. Please check the project name."
            exit 1
          fi

          echo "Project ID: $PROJECT_ID"

          PLAYBOOK_PATH="playbook_awx.yml"  # Update with your actual playbook path
          echo $PLAYBOOK_PATH
         
          done
